/*
* Платежный модуль Интеркасса (сниппет)
* Совместим с MODX REVO 2.5.0 (версии 2.х.х тоже должны быть совместимы, возможно с некоторыми поправками в коде)!
* Модуль требует наличие плагина ShopKeeper 3.0, 2.0 тоже будет работать, только нужно сменить переменные и вызовы $modx функций!
* version 1.3


==============================
Инструкция по установке модуля
==============================

Для установки платежного модуля "Интеркасса" необходимо произвести следующие действия:

=============================================
 Автоматическая установка в менеджере пакетов:
=============================================

1. Скачайте архив модуля, зайдите в менеджер пакетов (установщик), выберите загрузить пакет локально, выберите модуль на компьютере, загрузите.
2. После чего он появится в списке пакетов, установите его.

=============================================
 Ручная установка в менеджере пакетов:
============================================= 

1. Скачайте архив модуля. Загрузите архив в папку core/packages/ вашего сайта.
2. В панели управления перейдите "Система" - "Управление пакетами" - "Добавить новый пакет" - 		"Искать пакеты локально" - "Дальше".
3. В таблице пакетов появится пакет "Interkassa". Нажмите кнопку "Установить".
4. Завершите установку.

=============================================
 Подготовка системы и модуля к работе:
============================================= 

1. Необходимо создать 4 страницы:

*   страница оплаты через Interkassa. 
    Вставить в поле "Содержимое ресурса" вызов сниппета:

    [[!Interkassa? action=`payment`]]

*   страница с сообщением об успешной оплате (с любым содержанием)
    Пример: 

    Оплата заказа №[[+shk.id]] прошла успешно на сумму [[+shk.price]] [[+shk.currency]]

*   страница с сообщением об отмене оплаты. Вставить в поле "Содержимое ресурса" вызов сниппета:

    [[!Interkassa? action=`fail`]]

*   страница для подтверждения оплаты. Вставить в поле "Содержимое ресурса" вызов сниппета:

    [[!Interkassa? action=`callback`]]

    P.S. при работе модуля ShopKeeper3 используется сниппет Formit для валидации формы оплаты,
    в вызове сниппета можно добавить хук Interkassa перед redirect, что позволит автоматически
    сделать редирект на форму с оплатой. Однако этого можно и не делать, по умолчанию модуль
    отправляет пользователя на страницу с id=10, поэтому ее можно просто создать и 
    вставить туда вызов сниппета интеркассы [[!Interkassa? action=`callback`]]

2. Измените параметры сниппета Interkassa:

    CURRENCY_CODE - Код валюты платежа (валюта должна соответствовать валюте кошелька)
    MERCHANT_ID – номер кошелька в системе Интеркасса
    SECRET_KEY - секретный ключ
    TEST_KEY - тестовый секретный ключ
    TEST_MODE - включение тестового режима для отладки модуля (выключить при обычном использовании)
    TYPE_SIGNATURE - тип шифрования указанный в кабинете - "Безопасность" (md5 или sha256)
    
    Эти данные необходимо скопировать и ввести в кабинете Интеркассы в раздел - "Интерфейс"
    URL_FAIL - http://имя_вашего_сайта/index.php?id=ID_страницы
        ID_страницы - страница с сообщением об отмене оплаты
    URL_STATUS - http://имя_вашего_сайта/index.php?id=ID_страницы
        ID_страницы - страница с формой оплаты PayAnyWay
    URL_SUCCES - http://имя_вашего_сайта/index.php?id=ID_страницы
        ID_страницы - страница с формой оплаты PayAnyWay

3. В меню ShopKeeper3 перейти в раздел настройки, выбрать "Методы оплаты". Вписать "Имя" - Интеркасса, "значение" - interkassa. Сохранить настройки, после чего в форме офомрления заказа появится в списке метод оплаты "Интеркасса"

4. Зайти в шаблон страницы корзина:
    Найти место вызова плагина [[!FormIt? ....
    изменить ID страницы оплаты &redirectTo=`ID страницы оплаты` ID можно увидеть в списке страниц в (таких скобках).
    далее в хуках добавить еще один хук на оплату: &hooks=`spam,shk_fihook,email,FormItAutoResponder,redirect,payment` payment - вот это дописать после запятой.

5. Зайти в раздел снипетов, выбрать снипет Shopkeeper3, перейти на вкладку параметров, найти параметр orderFormPageId и установить его значение на тот же ID который мы указали на странице Корзины, Сохранить настройки.

6. Найти в списке чанков чанк shopOrderForm, открыть его, проверить в коде в блоке вызова сниппета [[!shkOptions? опцию &get=`delivery,payments,delivery_name,delivery_price,currency` и &post_name=`shk_delivery,payment`
    в них должны присутствовать вызовы оплаты в &get - payments, &post_name - payment.
    Также если в форме на страничке заказа нету выбора способа оплаты, его можно легко добавить в любое удобное для вас место, скопировав следующий код:

    <select name="payment" class="selectorder textfield" >
        <option value="">Выберите способ Оплаты</option>
        [[!+shkopt_payments]]
    </select>
    <div>[[!+fi.error.payment]]</div><br />

    HTML обертка может быть любая, важно добавить в селект вызов сниппета [[!+shkopt_payments]], и внизу добавить вызов блока в случае ошибки [[!+fi.error.payment]], имя у поля select - "payment".

=============================================
                Удачных продаж!
=============================================